<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Attivit√† Team</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.26.0/js/msal-browser.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --primary: #1F4E79;
  --secondary: #2E86C1;
  --success: #27AE60;
  --danger: #E74C3C;
  --light: #F8F9FA;
  --gray: #6C757D;
  --border: #DEE2E6;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  overflow: hidden;
}
.header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: white;
  padding: 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.header h1 { font-size: 28px; font-weight: 700; }
.header-right { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
.user-info { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 8px; }
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.btn-secondary { background: var(--secondary); color: white; }
.btn-secondary:hover { background: #1e5a8e; }
.btn-success { background: var(--success); color: white; }
.btn-success:hover { background: #1e7e34; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #c0392b; }
.nav-tabs { display: flex; background: var(--light); border-bottom: 2px solid var(--border); overflow-x: auto; }
.nav-tab {
  padding: 15px 25px;
  cursor: pointer;
  border: none;
  background: none;
  font-weight: 600;
  color: var(--gray);
  transition: all 0.3s ease;
  white-space: nowrap;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
}
.nav-tab:hover { color: var(--primary); background: rgba(31,78,121,0.05); }
.nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.content { padding: 30px; }
.dashboard { display: none; }
.dashboard.active { display: block; }
.filter-bar {
  background: var(--light);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}
.filter-bar label { font-weight: 600; color: var(--primary); font-size: 14px; }
.filter-bar select { padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; cursor: pointer; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: white; border: 2px solid var(--border); border-radius: 10px; padding: 20px; text-align: center; }
.stat-card i { font-size: 32px; color: var(--primary); margin-bottom: 10px; }
.stat-card .label { color: var(--gray); font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
.stat-card .value { font-size: 28px; font-weight: 700; color: var(--primary); }
.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.chart-container { background: white; border: 2px solid var(--border); border-radius: 10px; padding: 20px; }
.chart-container h3 { margin-bottom: 15px; color: var(--primary); }
.login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; max-width: 400px; }
.login-box h1 { color: var(--primary); margin-bottom: 30px; font-size: 28px; }
.login-box button { width: 100%; padding: 15px; font-size: 16px; margin-top: 20px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
</style>
</head>
<body>
<div id="login-screen" class="login-screen">
<div class="login-box">
<h1><i class="fas fa-tasks"></i> Registro Attivit√†</h1>
<p style="color: var(--gray); margin-bottom: 30px;">Accedi con il tuo account Microsoft</p>
<button class="btn btn-secondary" onclick="loginWithMicrosoft()" style="width: 100%; padding: 15px; font-size: 16px;">
<i class="fas fa-sign-in-alt"></i> Accedi con Microsoft
</button>
</div>
</div>

<div id="app-screen" style="display: none;">
<div class="container">
<div class="header">
<div><h1><i class="fas fa-tasks"></i> Registro Attivit√† Team</h1></div>
<div class="header-right">
<div class="user-info"><i class="fas fa-user-circle"></i><span id="user-name">Utente</span></div>
<button class="btn btn-secondary" onclick="syncWithOneDrive()"><i class="fas fa-cloud-upload-alt"></i> Sincronizza</button>
<button class="btn btn-secondary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
<button class="btn btn-secondary" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Esci</button>
</div>
</div>
<div class="nav-tabs">
<button class="nav-tab active" onclick="switchTab('dashboard',this)"><i class="fas fa-chart-line"></i> Dashboard</button>
<button class="nav-tab" onclick="switchTab('progetti',this)"><i class="fas fa-folder"></i> Progetti</button>
<button class="nav-tab" onclick="switchTab('gennaio',this)"><i class="fas fa-calendar"></i> Gennaio</button>
<button class="nav-tab" onclick="switchTab('febbraio',this)">Febbraio</button>
<button class="nav-tab" onclick="switchTab('marzo',this)">Marzo</button>
<button class="nav-tab" onclick="switchTab('aprile',this)">Aprile</button>
<button class="nav-tab" onclick="switchTab('maggio',this)">Maggio</button>
<button class="nav-tab" onclick="switchTab('giugno',this)">Giugno</button>
<button class="nav-tab" onclick="switchTab('luglio',this)">Luglio</button>
<button class="nav-tab" onclick="switchTab('agosto',this)">Agosto</button>
<button class="nav-tab" onclick="switchTab('settembre',this)">Settembre</button>
<button class="nav-tab" onclick="switchTab('ottobre',this)">Ottobre</button>
<button class="nav-tab" onclick="switchTab('novembre',this)">Novembre</button>
<button class="nav-tab" onclick="switchTab('dicembre',this)">Dicembre</button>
</div>
<div class="content">
<div id="dashboard" class="dashboard active">
<h2 style="color:var(--primary);margin-bottom:20px;">üìä Dashboard</h2>
<div class="filter-bar">
<label>Anno:</label>
<select id="year-filter" onchange="updateDashboard()"><option value="">Tutti gli anni</option></select>
<label>Persona:</label>
<select id="person-filter" onchange="updateDashboard()">
<option value="">Tutte le persone</option>
<option value="Francesco Marzaro">Francesco Marzaro</option>
<option value="Roberto Zampieri">Roberto Zampieri</option>
<option value="Saverio Manduca">Saverio Manduca</option>
</select>
</div>
<div class="stats-grid">
<div class="stat-card"><i class="fas fa-tasks"></i><div class="label">Attivit√† Totali</div><div class="value" id="stat-activities">0</div></div>
<div class="stat-card"><i class="fas fa-check-circle"></i><div class="label">Completate</div><div class="value" id="stat-completed">0</div></div>
<div class="stat-card"><i class="fas fa-clock"></i><div class="label">Ore Pianificate</div><div class="value" id="stat-hours">0</div></div>
<div class="stat-card"><i class="fas fa-hourglass-end"></i><div class="label">Ore Effettive</div><div class="value" id="stat-hours-actual">0</div></div>
<div class="stat-card"><i class="fas fa-euro-sign"></i><div class="label">Costo Totale</div><div class="value" id="stat-cost">‚Ç¨0</div></div>
</div>
<div class="charts-grid">
<div class="chart-container"><h3>Ore per Persona</h3><canvas id="hoursByPersonChart"></canvas></div>
<div class="chart-container"><h3>Stato Attivit√†</h3><canvas id="statusChart"></canvas></div>
<div class="chart-container" style="grid-column:1/-1;"><h3>Andamento Mensile</h3><canvas id="monthlyChart"></canvas></div>
</div>
</div>
<div id="progetti" class="dashboard">
<h2 style="color:var(--primary);margin-bottom:20px;">üìÅ Gestione Progetti</h2>
<div style="background:var(--light);padding:20px;border-radius:10px;margin-bottom:30px;">
<h3 style="color:var(--primary);margin-bottom:15px;">Aggiungi Nuovo Progetto</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px;">
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Nome Cliente</label><input type="text" id="project-client" placeholder="es. Acme" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Nome Progetto</label><input type="text" id="project-name" placeholder="es. Website" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Responsabile</label><select id="project-person" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="">Seleziona...</option><option value="Francesco Marzaro">Francesco Marzaro</option><option value="Roberto Zampieri">Roberto Zampieri</option><option value="Saverio Manduca">Saverio Manduca</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Budget Ore</label><input type="number" id="project-budget" placeholder="120" min="0" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Tariffa ‚Ç¨/h</label><input type="number" id="project-rate" value="35" min="0" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Scadenza</label><input type="date" id="project-deadline" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
</div>
<button class="btn btn-success" onclick="addProject()"><i class="fas fa-plus"></i> Aggiungi Progetto</button>
</div>
<div id="projects-list" style="display:flex;gap:20px;overflow-x:auto;padding-bottom:15px;"></div>
</div>
<div id="gennaio" class="dashboard">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
<button onclick="changeMonth(-1)" style="background:var(--primary);color:white;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
<h2 id="current-month" style="color:var(--primary);">Gennaio</h2>
<button onclick="changeMonth(1)" style="background:var(--primary);color:white;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
</div>
<div style="background:var(--light);padding:20px;border-radius:10px;margin-bottom:30px;">
<h3 style="color:var(--primary);margin-bottom:15px;">Aggiungi Attivit√†</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px;">
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Data</label><input type="date" id="activity-date" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Persona</label><select id="activity-person" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="">Seleziona...</option><option value="Francesco Marzaro">Francesco Marzaro</option><option value="Roberto Zampieri">Roberto Zampieri</option><option value="Saverio Manduca">Saverio Manduca</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Progetto</label><select id="activity-project" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="">Seleziona...</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Attivit√†</label><input type="text" id="activity-name" placeholder="Descrizione" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Link</label><input type="url" id="activity-link" placeholder="https://..." style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Ore Pianificate</label><input type="number" id="activity-hours-plan" placeholder="0" min="0" step="0.5" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Ore Effettive</label><input type="number" id="activity-hours-actual" placeholder="0" min="0" step="0.5" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Avanzamento %</label><input type="range" id="activity-progress" min="0" max="100" value="0" style="width:100%;"><span id="progress-value">0%</span></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Stato</label><select id="activity-status" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="Da Iniziare">Da Iniziare</option><option value="In Corso">In Corso</option><option value="Completato">Completato</option><option value="In Attesa">In Attesa</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Note</label><textarea id="activity-notes" placeholder="Note..." style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;min-height:80px;"></textarea></div>
</div>
<button class="btn btn-success" onclick="addActivity()"><i class="fas fa-plus"></i> Aggiungi Attivit√†</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px;background:var(--light);padding:15px;border-radius:10px;">
<div style="text-align:center;"><div style="color:var(--gray);font-size:12px;margin-bottom:5px;">Attivit√†</div><div style="font-size:20px;font-weight:700;color:var(--primary);" id="month-total">0</div></div>
<div style="text-align:center;"><div style="color:var(--gray);font-size:12px;margin-bottom:5px;">Ore Pianificate</div><div style="font-size:20px;font-weight:700;color:var(--primary);" id="month-hours-plan">0</div></div>
<div style="text-align:center;"><div style="color:var(--gray);font-size:12px;margin-bottom:5px;">Ore Effettive</div><div style="font-size:20px;font-weight:700;color:var(--primary);" id="month-hours-actual">0</div></div>
<div style="text-align:center;"><div style="color:var(--gray);font-size:12px;margin-bottom:5px;">Costo</div><div style="font-size:20px;font-weight:700;color:var(--success);" id="month-cost">‚Ç¨0</div></div>
</div>
<div style="overflow-x:auto;border:2px solid var(--border);border-radius:10px;">
<table style="width:100%;border-collapse:collapse;">
<thead style="background:var(--primary);color:white;">
<tr><th style="padding:15px;text-align:left;font-weight:600;">Data</th><th style="padding:15px;text-align:left;font-weight:600;">Persona</th><th style="padding:15px;text-align:left;font-weight:600;">Progetto</th><th style="padding:15px;text-align:left;font-weight:600;">Attivit√†</th><th style="padding:15px;text-align:left;font-weight:600;">Ore Plan</th><th style="padding:15px;text-align:left;font-weight:600;">Ore Eff</th><th style="padding:15px;text-align:left;font-weight:600;">Costo</th><th style="padding:15px;text-align:left;font-weight:600;">Avanzamento</th><th style="padding:15px;text-align:left;font-weight:600;">Stato</th><th style="padding:15px;text-align:left;font-weight:600;">Azioni</th></tr>
</thead>
<tbody id="activities-table" style="background:white;">
<tr><td colspan="10" style="padding:40px;text-align:center;color:var(--gray);">Nessuna attivit√†</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<!-- MODALI -->
<div id="edit-project-modal" class="modal">
<div class="modal-content">
<h2 style="color:var(--primary);margin-bottom:20px;">‚úèÔ∏è Modifica Progetto</h2>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
<input type="hidden" id="edit-project-id">
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Nome Cliente</label><input type="text" id="edit-project-client" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Nome Progetto</label><input type="text" id="edit-project-name" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Responsabile</label><select id="edit-project-person" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="Francesco Marzaro">Francesco Marzaro</option><option value="Roberto Zampieri">Roberto Zampieri</option><option value="Saverio Manduca">Saverio Manduca</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Budget Ore</label><input type="number" id="edit-project-budget" min="0" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Tariffa ‚Ç¨/h</label><input type="number" id="edit-project-rate" min="0" value="35" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Scadenza</label><input type="date" id="edit-project-deadline" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
</div>
<div style="margin-top:20px;display:flex;gap:10px;">
<button class="btn btn-success" onclick="saveProjectEdit()">Salva</button>
<button class="btn btn-secondary" onclick="closeProjectModal()">Annulla</button>
</div>
</div>
</div>

<div id="confirm-delete-project-modal" class="modal">
<div class="modal-content" style="max-width:400px;text-align:center;">
<h2 style="color:var(--primary);margin-bottom:20px;">‚ö†Ô∏è Eliminare Progetto?</h2>
<p style="color:var(--gray);margin-bottom:30px;font-size:16px;">Sei sicuro? Tutti i dati andranno persi e non potrai recuperarli.</p>
<div style="display:flex;gap:10px;justify-content:center;">
<button class="btn btn-danger" onclick="confirmDeleteProject()" style="flex:1;">S√¨, Elimina</button>
<button class="btn btn-secondary" onclick="cancelDeleteProject()" style="flex:1;">Annulla</button>
</div>
</div>
</div>

<div id="edit-activity-modal" class="modal">
<div class="modal-content">
<h2 style="color:var(--primary);margin-bottom:20px;">‚úèÔ∏è Modifica Attivit√†</h2>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px;">
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Data</label><input type="date" id="edit-activity-date" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Persona</label><select id="edit-activity-person" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="">Seleziona...</option><option value="Francesco Marzaro">Francesco Marzaro</option><option value="Roberto Zampieri">Roberto Zampieri</option><option value="Saverio Manduca">Saverio Manduca</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Progetto</label><select id="edit-activity-project" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="">Seleziona...</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Attivit√†</label><input type="text" id="edit-activity-name" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Link</label><input type="url" id="edit-activity-link" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Ore Pianificate</label><input type="number" id="edit-activity-hours-plan" min="0" step="0.5" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Ore Effettive</label><input type="number" id="edit-activity-hours-actual" min="0" step="0.5" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Avanzamento %</label><input type="range" id="edit-activity-progress" min="0" max="100" style="width:100%;"><span id="edit-progress-value">0%</span></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Stato</label><select id="edit-activity-status" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;"><option value="Da Iniziare">Da Iniziare</option><option value="In Corso">In Corso</option><option value="Completato">Completato</option><option value="In Attesa">In Attesa</option></select></div>
<div><label style="font-weight:600;color:var(--primary);margin-bottom:5px;display:block;">Note</label><textarea id="edit-activity-notes" style="padding:10px;border:2px solid var(--border);border-radius:6px;width:100%;min-height:80px;"></textarea></div>
</div>
<div style="display:flex;gap:10px;justify-content:center;">
<button class="btn btn-success" onclick="saveActivityEdit()" style="flex:1;">Salva</button>
<button class="btn btn-secondary" onclick="closeEditActivityModal()" style="flex:1;">Annulla</button>
</div>
</div>
</div>

<div id="confirm-delete-activity-modal" class="modal">
<div class="modal-content" style="max-width:400px;text-align:center;">
<h2 style="color:var(--primary);margin-bottom:20px;">‚ö†Ô∏è Eliminare Attivit√†?</h2>
<p style="color:var(--gray);margin-bottom:30px;font-size:16px;">Sei sicuro? Tutti i dati andranno persi e non potrai recuperarli.</p>
<div style="display:flex;gap:10px;justify-content:center;">
<button class="btn btn-danger" onclick="confirmDeleteActivity()" style="flex:1;">S√¨, Elimina</button>
<button class="btn btn-secondary" onclick="cancelDeleteActivity()" style="flex:1;">Annulla</button>
</div>
</div>
</div>

<script>
const msalConfig = {
  auth: {
    clientId: "2a14e77e-36fc-4e4a-b7c9-cd2450be114e",
    authority: "https://login.microsoftonline.com/common",
    redirectUri: window.location.origin
  },
  cache: { cacheLocation: "localStorage" }
};

const msalInstance = new msal.PublicClientApplication(msalConfig);
let accessToken = null;
let userEmail = null;

let appState = {
  activities: [],
  projects: [],
  currentMonth: 0,
  HOURLY_RATE: 35,
  charts: {}
};

const MONTHS = ['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];
const MONTHS_IT = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];

async function loginWithMicrosoft() {
  try {
    const response = await msalInstance.loginPopup({
      scopes: ["Files.ReadWrite", "offline_access"]
    });
    accessToken = response.accessToken;
    userEmail = response.account.username;
    
    const isFirstAccess = !localStorage.getItem('user_' + userEmail);
    if (isFirstAccess) {
      await notifyFirstAccess(userEmail);
      localStorage.setItem('user_' + userEmail, 'authorized');
    }
    
    document.getElementById('user-name').textContent = userEmail;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'block';
    await loadFromOneDrive();
    initializeApp();
  } catch (error) {
    console.error('Errore login:', error);
    alert('Errore durante il login');
  }
}

async function loadFromOneDrive() {
  try {
    const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/sharedWithMe/Registro-Attivit√†-Team/dati.json:/content', {
      headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    if (response.ok) {
      const data = await response.json();
      appState.activities = data.activities || [];
      appState.projects = data.projects || [];
    }
  } catch (error) {
    console.log('Primo accesso');
  }
}

async function syncWithOneDrive() {
  try {
    const data = JSON.stringify({
      activities: appState.activities,
      projects: appState.projects,
      timestamp: new Date().toISOString()
    });
    
    const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/sharedWithMe/Registro-Attivit√†-Team/dati.json:/content', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: data
    });
    
    if (response.ok) {
      console.log('‚úÖ Sincronizzato');
    }
  } catch (error) {
    console.error('Errore:', error);
  }
}

async function notifyFirstAccess(email) {
  try {
    const formData = new FormData();
    formData.append('entry.1688720454', email);
    
    await fetch('https://docs.google.com/forms/d/e/1jJzf1yFPozwXmu69TY8JZFBivj-pB_4R548a2CJBO-A/formResponse', {
      method: 'POST',
      mode: 'no-cors',
      body: formData
    });
  } catch (error) {
    console.log('Notifica inviata');
  }
}

function logout() {
  msalInstance.logout();
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app-screen').style.display = 'none';
}

function initializeApp() {
  document.getElementById('activity-date').valueAsDate = new Date();
  updateProjectDropdown();
  renderProjects();
  renderActivities();
  updateDashboard();
  populateYearFilter();
  document.getElementById('activity-progress').addEventListener('input', function() {
    document.getElementById('progress-value').textContent = this.value + '%';
  });
  document.getElementById('edit-activity-progress').addEventListener('input', function() {
    document.getElementById('edit-progress-value').textContent = this.value + '%';
  });
  setInterval(syncWithOneDrive, 30000);
}

function populateYearFilter() {
  const yearSelect = document.getElementById('year-filter');
  const currentYear = new Date().getFullYear();
  for (let year = 2026; year <= currentYear + 10; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
  yearSelect.value = currentYear;
}

function getFilteredActivities() {
  const selectedYear = document.getElementById('year-filter').value;
  const selectedPerson = document.getElementById('person-filter').value;
  return appState.activities.filter(a => {
    const activityYear = new Date(a.date).getFullYear().toString();
    const yearMatch = !selectedYear || activityYear === selectedYear;
    const personMatch = !selectedPerson || a.person === selectedPerson;
    return yearMatch && personMatch;
  });
}

function switchTab(tab, element) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  element.classList.add('active');
  document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
  
  if (tab === 'dashboard') {
    document.getElementById('dashboard').classList.add('active');
    updateDashboard();
  } else if (tab === 'progetti') {
    document.getElementById('progetti').classList.add('active');
  } else {
    document.getElementById('gennaio').classList.add('active');
    appState.currentMonth = MONTHS.indexOf(tab);
    renderActivities();
  }
}

function addProject() {
  const data = {
    id: Date.now(),
    client: document.getElementById('project-client').value,
    name: document.getElementById('project-name').value,
    person: document.getElementById('project-person').value,
    budget: parseFloat(document.getElementById('project-budget').value) || 0,
    rate: parseFloat(document.getElementById('project-rate').value) || 35,
    deadline: document.getElementById('project-deadline').value,
    used: 0
  };
  
  if (!data.client || !data.name || !data.person) {
    alert('Compila cliente, nome progetto e responsabile');
    return;
  }
  
  appState.projects.push(data);
  updateProjectDropdown();
  renderProjects();
  document.getElementById('project-client').value = '';
  document.getElementById('project-name').value = '';
  document.getElementById('project-person').value = '';
  document.getElementById('project-budget').value = '';
  document.getElementById('project-deadline').value = '';
  syncWithOneDrive();
}

function updateProjectDropdown() {
  const select = document.getElementById('activity-project');
  select.innerHTML = '<option value="">Seleziona...</option>' + 
    appState.projects.map(p => `<option value="${p.name}">${p.client} - ${p.name}</option>`).join('');
}

function addActivity() {
  const projectName = document.getElementById('activity-project').value;
  const project = appState.projects.find(p => p.name === projectName);
  
  const data = {
    id: Date.now(),
    month: appState.currentMonth,
    date: document.getElementById('activity-date').value || new Date().toISOString().split('T')[0],
    year: new Date(document.getElementById('activity-date').value || new Date()).getFullYear(),
    person: document.getElementById('activity-person').value,
    project: projectName || 'Senza progetto',
    client: project ? project.client : '',
    name: document.getElementById('activity-name').value,
    link: document.getElementById('activity-link').value || '',
    hoursPlan: parseFloat(document.getElementById('activity-hours-plan').value) || 0,
    hoursActual: parseFloat(document.getElementById('activity-hours-actual').value) || 0,
    progress: parseInt(document.getElementById('activity-progress').value) || 0,
    status: document.getElementById('activity-status').value,
    notes: document.getElementById('activity-notes').value || ''
  };
  
  if (!data.person || !data.name) {
    alert('Compila almeno Persona e Attivit√†');
    return;
  }
  
  appState.activities.push(data);
  syncWithOneDrive();
  renderActivities();
  updateDashboard();
  
  document.getElementById('activity-name').value = '';
  document.getElementById('activity-link').value = '';
  document.getElementById('activity-hours-plan').value = '';
  document.getElementById('activity-hours-actual').value = '';
  document.getElementById('activity-progress').value = '0';
  document.getElementById('progress-value').textContent = '0%';
  document.getElementById('activity-notes').value = '';
  document.getElementById('activity-project').value = '';
}

function changeMonth(delta) {
  appState.currentMonth += delta;
  if (appState.currentMonth > 11) appState.currentMonth = 0;
  if (appState.currentMonth < 0) appState.currentMonth = 11;
  renderActivities();
}

function renderActivities() {
  document.getElementById('current-month').textContent = MONTHS_IT[appState.currentMonth];
  const monthActivities = appState.activities.filter(a => a.month === appState.currentMonth);
  const tbody = document.getElementById('activities-table');
  
  if (monthActivities.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="padding:40px;text-align:center;color:var(--gray);">Nessuna attivit√†</td></tr>';
  } else {
    tbody.innerHTML = monthActivities.map(a => `
      <tr>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);">${new Date(a.date).toLocaleDateString('it-IT')}</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);">${a.person}</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);">${a.project}</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);">${a.name}</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);">${a.hoursPlan}</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);">${a.hoursActual}</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);color:var(--success);font-weight:600;">‚Ç¨${(a.hoursActual * appState.HOURLY_RATE).toFixed(0)}</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);">${a.progress}%</td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);"><span style="display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;background:#E3F2FD;color:#2E86C1;">${a.status}</span></td>
        <td style="padding:12px 15px;border-bottom:1px solid var(--border);"><button onclick="editActivity(${a.id})" style="padding:6px 10px;border:none;border-radius:4px;cursor:pointer;background:var(--secondary);color:white;margin-right:5px;"><i class="fas fa-edit"></i></button><button onclick="deleteActivity(${a.id})" style="padding:6px 10px;border:none;border-radius:4px;cursor:pointer;background:var(--danger);color:white;"><i class="fas fa-trash"></i></button></td>
      </tr>
    `).join('');
  }
  
  const total = monthActivities.length;
  const hoursPlan = monthActivities.reduce((sum, a) => sum + a.hoursPlan, 0);
  const hoursActual = monthActivities.reduce((sum, a) => sum + a.hoursActual, 0);
  const cost = hoursActual * appState.HOURLY_RATE;
  
  document.getElementById('month-total').textContent = total;
  document.getElementById('month-hours-plan').textContent = hoursPlan.toFixed(1);
  document.getElementById('month-hours-actual').textContent = hoursActual.toFixed(1);
  document.getElementById('month-cost').textContent = `‚Ç¨${cost.toFixed(0)}`;
  
  updateProjectHours();
}

let activityToDelete = null;

function deleteActivity(id) {
  activityToDelete = id;
  document.getElementById('confirm-delete-activity-modal').classList.add('active');
}

function confirmDeleteActivity() {
  if (activityToDelete !== null) {
    appState.activities = appState.activities.filter(a => a.id !== activityToDelete);
    syncWithOneDrive();
    renderActivities();
    updateDashboard();
    document.getElementById('confirm-delete-activity-modal').classList.remove('active');
    activityToDelete = null;
  }
}

function cancelDeleteActivity() {
  document.getElementById('confirm-delete-activity-modal').classList.remove('active');
  activityToDelete = null;
}

let activityToEdit = null;

function editActivity(id) {
  const activity = appState.activities.find(a => a.id === id);
  if (!activity) return;
  
  activityToEdit = id;
  document.getElementById('edit-activity-date').value = activity.date;
  document.getElementById('edit-activity-person').value = activity.person;
  document.getElementById('edit-activity-project').value = activity.project;
  document.getElementById('edit-activity-name').value = activity.name;
  document.getElementById('edit-activity-link').value = activity.link;
  document.getElementById('edit-activity-hours-plan').value = activity.hoursPlan;
  document.getElementById('edit-activity-hours-actual').value = activity.hoursActual;
  document.getElementById('edit-activity-progress').value = activity.progress;
  document.getElementById('edit-progress-value').textContent = activity.progress + '%';
  document.getElementById('edit-activity-status').value = activity.status;
  document.getElementById('edit-activity-notes').value = activity.notes;
  
  const select = document.getElementById('edit-activity-project');
  select.innerHTML = '<option value="">Seleziona...</option>' + 
    appState.projects.map(p => `<option value="${p.name}">${p.client} - ${p.name}</option>`).join('');
  select.value = activity.project;
  
  document.getElementById('edit-activity-modal').classList.add('active');
}

function saveActivityEdit() {
  if (activityToEdit === null) return;
  
  const activity = appState.activities.find(a => a.id === activityToEdit);
  if (!activity) return;
  
  activity.date = document.getElementById('edit-activity-date').value;
  activity.person = document.getElementById('edit-activity-person').value;
  activity.project = document.getElementById('edit-activity-project').value;
  activity.name = document.getElementById('edit-activity-name').value;
  activity.link = document.getElementById('edit-activity-link').value;
  activity.hoursPlan = parseFloat(document.getElementById('edit-activity-hours-plan').value) || 0;
  activity.hoursActual = parseFloat(document.getElementById('edit-activity-hours-actual').value) || 0;
  activity.progress = parseInt(document.getElementById('edit-activity-progress').value) || 0;
  activity.status = document.getElementById('edit-activity-status').value;
  activity.notes = document.getElementById('edit-activity-notes').value;
  
  syncWithOneDrive();
  closeEditActivityModal();
  renderActivities();
  updateDashboard();
}

function closeEditActivityModal() {
  document.getElementById('edit-activity-modal').classList.remove('active');
  activityToEdit = null;
}

function renderProjects() {
  const container = document.getElementById('projects-list');
  if (appState.projects.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--gray);width:100%;"><i class="fas fa-folder-open" style="font-size:64px;margin-bottom:20px;opacity:0.5;"></i><p>Nessun progetto</p></div>';
    return;
  }
  
  container.innerHTML = appState.projects.map(p => {
    const percent = p.budget > 0 ? (p.used / p.budget * 100) : 0;
    const remaining = p.budget - p.used;
    
    return `<div style="background:white;border:2px solid var(--border);border-radius:10px;padding:20px;min-width:350px;flex-shrink:0;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px;">
        <div>
          <div style="color:var(--secondary);font-weight:600;font-size:12px;margin-bottom:5px;">üë§ ${p.client}</div>
          <h4 style="color:var(--primary);margin-bottom:5px;">${p.name}</h4>
          <div style="color:var(--gray);font-size:13px;">üë®‚Äçüíº ${p.person}</div>
        </div>
        <div style="display:flex;gap:5px;">
          <button onclick="editProject(${p.id})" style="padding:6px 10px;border:none;border-radius:4px;cursor:pointer;background:var(--secondary);color:white;"><i class="fas fa-edit"></i></button>
          <button onclick="deleteProject(${p.id})" style="padding:6px 10px;border:none;border-radius:4px;cursor:pointer;background:var(--danger);color:white;"><i class="fas fa-trash"></i></button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
        <div style="background:var(--light);padding:10px;border-radius:6px;"><div style="font-size:12px;color:var(--gray);">Budget Ore</div><div style="font-weight:700;color:var(--primary);">${p.budget}h</div></div>
        <div style="background:var(--light);padding:10px;border-radius:6px;"><div style="font-size:12px;color:var(--gray);">Ore Utilizzate</div><div style="font-weight:700;color:var(--primary);">${p.used.toFixed(1)}h</div></div>
        <div style="background:var(--light);padding:10px;border-radius:6px;"><div style="font-size:12px;color:var(--gray);">Ore Rimanenti</div><div style="font-weight:700;color:var(--primary);">${remaining.toFixed(1)}h</div></div>
        <div style="background:var(--light);padding:10px;border-radius:6px;"><div style="font-size:12px;color:var(--gray);">Tariffa</div><div style="font-weight:700;color:var(--success);">‚Ç¨${p.rate}/h</div></div>
      </div>
      <div style="width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:10px;">
        <div style="height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));width:${Math.min(percent, 100)}%;"></div>
      </div>
      <div style="font-size:12px;color:var(--gray);">${percent.toFixed(1)}% ore utilizzato</div>
    </div>`;
  }).join('');
}

let projectToDelete = null;

function editProject(id) {
  const project = appState.projects.find(p => p.id === id);
  if (!project) return;
  
  document.getElementById('edit-project-id').value = id;
  document.getElementById('edit-project-client').value = project.client;
  document.getElementById('edit-project-name').value = project.name;
  document.getElementById('edit-project-person').value = project.person;
  document.getElementById('edit-project-budget').value = project.budget;
  document.getElementById('edit-project-rate').value = project.rate;
  document.getElementById('edit-project-deadline').value = project.deadline;
  document.getElementById('edit-project-modal').classList.add('active');
}

function saveProjectEdit() {
  const id = parseInt(document.getElementById('edit-project-id').value);
  const project = appState.projects.find(p => p.id === id);
  if (!project) return;
  
  project.client = document.getElementById('edit-project-client').value;
  project.name = document.getElementById('edit-project-name').value;
  project.person = document.getElementById('edit-project-person').value;
  project.budget = parseFloat(document.getElementById('edit-project-budget').value) || 0;
  project.rate = parseFloat(document.getElementById('edit-project-rate').value) || 35;
  project.deadline = document.getElementById('edit-project-deadline').value;
  
  syncWithOneDrive();
  closeProjectModal();
  updateProjectDropdown();
  renderProjects();
}

function closeProjectModal() {
  document.getElementById('edit-project-modal').classList.remove('active');
}

function deleteProject(id) {
  projectToDelete = id;
  document.getElementById('confirm-delete-project-modal').classList.add('active');
}

function confirmDeleteProject() {
  if (projectToDelete !== null) {
    appState.projects = appState.projects.filter(p => p.id !== projectToDelete);
    syncWithOneDrive();
    updateProjectDropdown();
    renderProjects();
    document.getElementById('confirm-delete-project-modal').classList.remove('active');
    projectToDelete = null;
  }
}

function cancelDeleteProject() {
  document.getElementById('confirm-delete-project-modal').classList.remove('active');
  projectToDelete = null;
}

function updateProjectHours() {
  appState.projects.forEach(p => {
    p.used = appState.activities.filter(a => a.project === p.name).reduce((sum, a) => sum + a.hoursActual, 0);
  });
  renderProjects();
}

function updateDashboard() {
  const filteredActivities = getFilteredActivities();
  const totalActivities = filteredActivities.length;
  const completedActivities = filteredActivities.filter(a => a.progress >= 100).length;
  const totalHoursPlan = filteredActivities.reduce((sum, a) => sum + a.hoursPlan, 0);
  const totalHoursActual = filteredActivities.reduce((sum, a) => sum + a.hoursActual, 0);
  const totalCost = totalHoursActual * appState.HOURLY_RATE;
  
  document.getElementById('stat-activities').textContent = totalActivities;
  document.getElementById('stat-completed').textContent = completedActivities;
  document.getElementById('stat-hours').textContent = totalHoursPlan.toFixed(1);
  document.getElementById('stat-hours-actual').textContent = totalHoursActual.toFixed(1);
  document.getElementById('stat-cost').textContent = `‚Ç¨${totalCost.toFixed(0)}`;
  
  const personHours = {};
  filteredActivities.forEach(a => {
    if (!personHours[a.person]) personHours[a.person] = { plan: 0, actual: 0 };
    personHours[a.person].plan += a.hoursPlan;
    personHours[a.person].actual += a.hoursActual;
  });
  
  if (appState.charts.hoursByPerson) appState.charts.hoursByPerson.destroy();
  const ctx1 = document.getElementById('hoursByPersonChart');
  if (ctx1) {
    appState.charts.hoursByPerson = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: Object.keys(personHours),
        datasets: [
          { label: 'Ore Pianificate', data: Object.values(personHours).map(p => p.plan), backgroundColor: '#1F4E79' },
          { label: 'Ore Effettive', data: Object.values(personHours).map(p => p.actual), backgroundColor: '#2E86C1' }
        ]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }
  
  const statusCount = { 'Da Iniziare': 0, 'In Corso': 0, 'Completato': 0, 'In Attesa': 0 };
  filteredActivities.forEach(a => {
    if (statusCount[a.status] !== undefined) statusCount[a.status]++;
  });
  
  if (appState.charts.status) appState.charts.status.destroy();
  const ctx2 = document.getElementById('statusChart');
  if (ctx2) {
    appState.charts.status = new Chart(ctx2, {
      type: 'pie',
      data: {
        labels: Object.keys(statusCount),
        datasets: [{ data: Object.values(statusCount), backgroundColor: ['#F39C12', '#2E86C1', '#27AE60', '#E74C3C'] }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }
  
  const monthlyData = MONTHS.map((_, i) => {
    const monthActivities = filteredActivities.filter(a => a.month === i);
    return monthActivities.reduce((sum, a) => sum + a.hoursActual, 0);
  });
  
  if (appState.charts.monthly) appState.charts.monthly.destroy();
  const ctx3 = document.getElementById('monthlyChart');
  if (ctx3) {
    appState.charts.monthly = new Chart(ctx3, {
      type: 'line',
      data: {
        labels: MONTHS_IT,
        datasets: [{
          label: 'Ore Mensili',
          data: monthlyData,
          borderColor: '#1F4E79',
          backgroundColor: 'rgba(31,78,121,0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }
}

function exportToExcel() {
  try {
    const workbook = new ExcelJS.Workbook();
    const ws = workbook.addWorksheet('Attivit√†');
    
    ws.columns = [
      { header: 'Data', key: 'date', width: 12 },
      { header: 'Persona', key: 'person', width: 18 },
      { header: 'Progetto', key: 'project', width: 20 },
      { header: 'Attivit√†', key: 'name', width: 30 },
      { header: 'Ore Pianificate', key: 'hoursPlan', width: 14 },
      { header: 'Ore Effettive', key: 'hoursActual', width: 14 },
      { header: 'Costo ‚Ç¨', key: 'cost', width: 12 },
      { header: 'Avanzamento %', key: 'progress', width: 14 },
      { header: 'Stato', key: 'status', width: 14 }
    ];
    
    ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F4E79' } };
    ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
    
    appState.activities.forEach(a => {
      const cost = a.hoursActual * appState.HOURLY_RATE;
      ws.addRow({
        date: a.date,
        person: a.person,
        project: a.project,
        name: a.name,
        hoursPlan: a.hoursPlan,
        hoursActual: a.hoursActual,
        cost: cost,
        progress: a.progress,
        status: a.status
      });
    });
    
    workbook.xlsx.writeBuffer().then(buffer => {
      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `registro_attivita_${new Date().toISOString().split('T')[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  } catch (e) {
    console.error('Errore:', e);
    alert('Errore durante l\'esportazione');
  }
}

msalInstance.handleRedirectPromise().then(() => {
  const account = msalInstance.getActiveAccount();
  if (account) {
    userEmail = account.username;
    document.getElementById('user-name').textContent = userEmail;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'block';
    msalInstance.acquireTokenSilent({
      scopes: ["Files.ReadWrite"],
      account: account
    }).then(response => {
      accessToken = response.accessToken;
      loadFromOneDrive().then(() => initializeApp());
    });
  }
}).catch(error => {
  console.error('Errore:', error);
});
</script>
</body>
</html>
